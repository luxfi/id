services:
  lux-id-dev:
    restart: always
    build:
      context: ./
      dockerfile: Dockerfile
      target: STANDARD
    entrypoint: /bin/sh -c './server --createDatabase=true'
    extra_hosts:
      - "id-dev.lux.network:host-gateway"
      - "172.17.0.1:host-gateway"
    depends_on:
      - lux-id-dev-db
      - redis-lux-id-dev
    environment:
      RUNNING_IN_DOCKER: "true"
    
    # volumes:
    #   - ./conf/app_dev.conf:/conf/app.conf
    #   - /etc/lux/compose/lux-id-prod-c0gkof/files/app.conf:/conf/app.conf
    tmpfs:
      - /tmp:exec,mode=1777
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.well-known.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.lux-id-dev-csp.headers.customResponseHeaders.Content-Security-Policy=connect-src 'self' https://id-dev.lux.network http://id-dev.lux.network;"
      - "traefik.http.routers.lux-id-dev-http.rule=Host(`id-dev.lux.network`)"
      - "traefik.http.routers.lux-id-dev-http.entrypoints=web"
      - "traefik.http.routers.lux-id-dev-http.middlewares=well-known,lux-id-dev-csp,redirect-to-https"
      - "traefik.http.routers.lux-id-dev-https.rule=Host(`id-dev.lux.network`)"
      - "traefik.http.routers.lux-id-dev-https.entrypoints=websecure"
      - "traefik.http.routers.lux-id-dev-https.middlewares=well-known,lux-id-dev-csp"
      - "traefik.http.routers.lux-id-dev-https.tls.certresolver=letsencrypt"
      - "traefik.http.services.lux-id-dev.loadbalancer.server.port=8000"
    networks:
      - lux-network
      - internal-dev-lux-id
  lux-id-dev-db:
    restart: always
    # image: mysql
    image: mysql:8.0.25
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
    volumes:
      - lux-id-dev-db:/var/lib/mysql
    networks:
      - internal-dev-lux-id
  redis-lux-id-dev:
    restart: always
    image: redis:7-alpine
    volumes:
      - lux-id-dev-redis:/data
    networks:
      - internal-dev-lux-id

volumes:
  lux-id-dev-db:
    name: lux-id-dev-db-volume
  lux-id-dev-redis:
    driver: local

networks:
  internal-dev-lux-id:
  lux-network:
    external: true